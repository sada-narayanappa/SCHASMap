<!DOCTYPE HTML>
<html>
<head>
    <title>SCHAS Maps</title>
    <meta charset="UTF-8">

    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>

    <script src="../js/config.prod.js"></script>
    <script src="../js/ajaxutils.js"></script>
    <script src="../js/generalutils.js"></script>
    <script src="../js/spatial1.js"></script>

    <script src="../js/useroptions.js"></script>
    <script src="Layers.js"></script>
    <script src="os.js"></script>
    <script src="utils.js"></script>
    <script src="citiesLayer.js"></script>
    <script src="stationsLayerVoronoi.js"></script>
    <script src="stationsLayer.js"></script>
    <script src="uaelayer.js"></script>
    <script src="syntheticStationsLayer.js"></script>
    <script src="stationsLayerDelaunay.js"></script>
    <script src="refinedStationsLayerDelaunay.js"></script>
    <script src="refinedStationLayerVoronoi.js"></script>
    <script src="roadsLayer.js"></script>
    <script src="routeLayer.js"></script>
    <script src="possibleRoutesLayer.js"></script>
    <script src="trackLayer.js"></script>
    <script src="syntheticLayer.js"></script>

    <link rel="stylesheet" type="text/css" href="screen.css">
    <link rel="stylesheet" type="text/css" href="SCHASstylesheet.css">

    <style type="text/css">
        #loginContent { width: 350px; margin: 100px auto; }
        #profileContent { width: 350px; margin: 100px auto; }
        button[type] { margin: 0.5em 0; }
    </style>
    <script>
        $(function() {
            $( "#tabs" ).tabs();
        });
        $(document).ready(function() {
            init();
            initUserSettings();
        });
        function initUserSettings() { //initialize the control panel settings
            getUserOptions();
            if ( !userOptions )
                userOptions = defaultUserOptions;
            runQuery1(); // load the information
            ControlPanelToggle(userOptions.controlPanel);
            if(userOptions.myUserID!==null){
                trackLayerUpdate(userOptions.myUserID, false,document.getElementById("invalidCheckbox").checked);
            }
            setUserOptions(map);
            var name = localStorage.getItem('name');
            console.log("name from localstorage is "+name);
            if (typeof name !== 'undefined' && name !== null){
                showMenu();
                $('[href="#tabs-3"]').closest('li').show();
            } else {
                console.log("name is null"+name);
                showloginForm();
                $('[href="#tabs-3"]').closest('li').show();
            }
        }
    </script>

</head>
<body>
<div id="mapdiv"></div>

<script>
    function ControlPanelToggle(onOff) {  //onOff = none, block -> if none ->opens
        d = onOff || document.getElementById('formcontent').style.display;
        if ( d == "none")  {
            d = "block";
            userOptions.controlPanel = "none"
            document.getElementById("ControlPanelImage").src = "http://www.clker.com/cliparts/O/S/I/l/m/L/minus-sign-subtract-md.png";
        } else {
            d = "none";
            userOptions.controlPanel = "block";
            document.getElementById("ControlPanelImage").src = "http://www.clker.com/cliparts/6/9/3/2/119499444664447017ark_new.svg.thumb.png";
        }
        document.getElementById('formcontent').style.display = d;
    }
</script>

<div id='form'>
    <form name="input" action="javascript: submitform();" method="post">
        <div style="font-variant: small-caps; text-align: right; width: 100%; background-color: grey">
            Control Panel
            <img id="ControlPanelImage" src="http://www.clker.com/cliparts/O/S/I/l/m/L/minus-sign-subtract-md.png"
                 width="16px" onclick="ControlPanelToggle()" /><hr/>
            <input type="button" value="Save my Options" onclick="saveUserOptions(map)"/>
            <input type="button" value="Set my Options" onclick="setUserOptions(map)"/>
            <hr/>
        </div>
        <div id="formcontent">
            <!-- <label for="query">Address/zip :</label>
            <input type="text" id="query" size=50 name="query" value="Menomonie, WI"/>

            <input type="button" value="Submit"/> -->
            <br>

            <hr size="1"/>

            <div id="tabs">
                <ul>
                    <li><a href="#tabs-1">Settings</a></li>
                    <li><a href="#tabs-3">Pick/ User</a></li>

                    <li><a href="#tabs-2">Find Routes</a></li>
                    <li><a href="#tabs-4">Probabilistic Route Analysis</a></li>

                </ul>
                <div id="tabs-1">

                    <div id="loginContent">
                        <div id="loginResult" style="display:none;">
                        </div>
                        <form id="loginForm" name="loginForm" method="post" action="">
                            <fieldset>
                                <legend>Enter information</legend>
                                <p>
                                    <label for="username">Username</label>

                                    <input type="text" id="username" name="username" class="text" size="10" />
                                </p>
                                <p>
                                    <label for="password">Password</label>

                                    <input type="password" id="password" name="password" class="text" size="10" />
                                </p>
                                <p>
                                    <button type="button" class="button positive" onclick="runQuery2();">
                                        <img alt="ok" src=
                                                "http://www.blueprintcss.org/blueprint/plugins/buttons/icons/tick.png" />
                                        Login
                                    </button>
                                    <button type="button" class="button positive" onclick="showCreateProfile()">                                        
                                        Create Account
                                    </button>
                                </p>
                            </fieldset>
                        </form>
                    </div>

                    <div id="createAccount" style="display: none;">
                        <form id="createAccountForm" name="createAccountForm" method="post" action="">
                            <legend>Create Account</legend>
                            <p>
                                <label for="createUsername">Username</label>
                                <input type="text" id="createUsername" name="createUsername" class="text" size="10" />
                            </p>
                            <p>
                                <label for="createPassword">Password</label>
                                <input type="password" id="createPassword" name="createPassword" class="text" size="10" />
                            </p>
                            <p>
                                <label for="createConfirmPassword">Confirm Password</label>
                                <input type="password" id="createConfirmPassword" onkeyup="checkPass(); return false;" name="createConfirmPassword" class="text" size="10" />
                                <span id="confirmMessage" class="confirmMessage"></span>
                            </p>
                            <p>
                                <label for="createFname">First Name</label>
                                <input type="text" id="createFname" name="createFname" class="text" size="30" />
                            </p>
                            <p>
                                <label for="createLname">Last Name</label>
                                <input type="text" id="createLname" name="createLname" class="text" size="30" />
                            </p>
                            <p>
                                <label for="createAddress">Address</label>
                                <input type="textarea" id="createAddress" name="createAddress" class="text"  />
                            </p>
                            <p>
                                <label for="createCellphone">cell phone</label>
                                <input type="text" id="createCellphone" name="createCellphone" class="text" size="20" />
                            </p>
                            <p>
                                <label for="createMobileid">Mobile id</label>
                                <input type="text" id="createMobileid" name="createMobileid" class="text" size="20" />
                            </p>
                            <p>
                                <label for="createHomephone">Home phone</label>
                                <input type="text" id="createHomephone" name="createHomephone" class="text" size="20" />
                            </p>
                            <p>
                                <label for="createHome_location">Home location</label>
                                <input type="text" id="createHome_location" name="createHome_location" class="text" size="20" />
                            </p>
                        </form>
                        <span id="createAccountMessage" class="createAccountMessage"></span>
                        <button type="button" class="button positive" onclick="checkUsername()">                                        
                                        Create
                        </button>
                        <button type="button" class="button positive" onclick="showloginForm()">                                        
                                        Cancel
                        </button>
                    </div>


                    <div id="useroptions">

                        <p>
                            <button type="button" class="button positive" onclick="getProfileFromDB();">

                                Edit Profile
                            </button>
                            |

                            <button type="button" class="button positive" onclick="changepassword();">

                                Change Password
                            </button>
                            |
                            <button type="button" class="button positive" onclick="logout();">

                                Log out
                            </button>
                        </p>
                    </div>



                    <div id="changePassword">
                        <div id="changePasswordResult" style="display:none;">
                        </div>
                        <form id="changePasswordForm" name="loginForm" method="post" action="">
                            <fieldset>
                                <legend>Enter information</legend>
                                <p>
                                    <label for="password">Enter current Password</label>

                                    <input type="password" id="currentPassword" name="currentPassword" class="text" size="10" />
                                </p>
                                <p>
                                    <label for="password">Enter New Password</label>

                                    <input type="password" id="newPassword" name="newPassword" class="text" size="10" />
                                </p>
                                <p>
                                    <label for="password">Repeat New Password</label>

                                    <input type="password" id="newPassword1" name="newPassword1" class="text" size="10" />
                                </p>
                                <span id="changePasswordMessage" class="changePasswordMessage"></span>
                                <p>
                                    <button type="button" class="button positive" onclick="checkPassword();">
                                        <img alt="ok" src=
                                                "http://www.blueprintcss.org/blueprint/plugins/buttons/icons/tick.png" />
                                        Change password
                                    </button>
                                </p>
                            </fieldset>
                        </form>
                    </div>

                    <div id="profile">
                        <div id="profileResult" style="display:none;">
                        </div>
                        <form id="profileForm" name="profileForm" method="post" action="">
                            <fieldset>
                                <legend>Update Personal Information</legend>
                                <p>
                                    <label for="fname">First Name</label>
                                    <input type="text" id="fname" name="fname" class="text" size="30" />
                                </p>
                                <p>
                                    <label for="lname">Last Name</label>
                                    <input type="text" id="lname" name="lname" class="text" size="30" />
                                </p>
                                <p>
                                    <label for="address">Address</label>
                                    <input type="textarea" id="address" name="address" class="text"  />
                                </p>
                                <p>
                                    <label for="cellphone">cell phone</label>
                                    <input type="text" id="cellphone" name="cellphone" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="mobileid">Mobile id</label>
                                    <input type="text" id="mobileid" name="mobileid" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="homephone">Home phone</label>
                                    <input type="text" id="homephone" name="homephone" class="text" size="20" />
                                </p>
                                <p>
                                    <label for="home_location">Home location</label>
                                    <input type="text" id="home_location" name="home_location" class="text" size="20" />
                                </p>


                                <p>
                                    <button type="button" class="button positive" onclick="runQuery3();">
                                        <img alt="ok" src=
                                                "http://www.blueprintcss.org/blueprint/plugins/buttons/icons/tick.png" />
                                        Update
                                    </button>
                                </p>
                            </fieldset>
                        </form>


                    </div>
                </div>

                <div id="tabs-2">
                    <p>Find interesting trajectories - query</p>
                    <input type="button" value="Place Start Node"  onclick="routeLayer.setCanAddStartPoint(true)" />
                    <input type="button" value="Place End Node"  onclick="routeLayer.setCanAddEndPoint(true)" />
                    <input type="button" value="Compute Route" onclick="routeLayer.instance.LayerUpdate()"/>
                </div>
               <div id="tabs-3" style="height:440px;overflow-y:auto;">
                    <input id="invalidCheckbox" type="checkbox" name="Invalid" value="show"> Show Invalid Points <hr>
                    <div id="sessiontracks"> </div>
                </div>
                <div id="tabs-4">
                    <p>Probabilistic Route Analysis</p>
                    <input type="button" value="Place Start Node"  onclick="possibleRoutesLayer.setCanAddStartPoint(true)" />
                    <input type="button" value="Place End Node"  onclick="possibleRoutesLayer.setCanAddEndPoint(true)" />
                    <input type="button" id="computeButton" value="Compute Route" onclick="possibleRoutesLayer.instance.LayerUpdate()"/>
                    <img src="loading.gif" id="loading" style="visibility:hidden" width="35" height="35"/>
                    <br>
                    Number of Routes: <input id="numRoutes" type="number" name="Number of Routes" value="1" min="1" style="width: 35px" max="15"/>
                    <br>                    
                    Time Length: <input id="time"  name="Route Time" placeholder="hh:mm:ss" style="width: 65px"/>
                    <br>
                    Digits of Precision: <input id="precisionDig" type="number" name="Digits of Precision" value="4" min="1" style="width: 35px" max="8"/>
                    <br>
                    <p id="elapsedTime"></p>
                    <br>
                    <input type="button" value="Analyze Route"  onclick="possibleRoutesLayer.analyzeRoute()" />
                    <br>
                    <div id="ResultsSection" style="width: 350px; height: 150px; overflow-y: scroll; display: none;">
                        <p id="ResultsParagraph"></p>
                    </div>
                </div>

            </div>

            <hr size="1"/>
            <a style="color: blue;" href="/" target="_blank">Map</a> |
            <div id="coords" style="height: 1.5em; display:inline; text-align: right"></div> |
            <a style="color: blue;" href="/SCHAS/html/maps/SCHASdevices/devices.html" target="_blank">SCHAS data</a> |
            <a style="color: blue;" href="/aura/webroot/db.jsp?cmd=reload" target="_blank">Reset</a>
        </div>
    </form>
</div>

<script>
    var userSysId;
    var GEOPROXY=window.location.origin;

    function clearAllMapPopups() {
        while( map.popups.length ) {
            map.removePopup(map.popups[0]);
        }
    }
    function setURL(parms) {
        s = top.window.location.href;
        if (s.lastIndexOf("?") > 0) {
            s = s.substring(a, s.lastIndexOf("?"));
        }
        s= s + "?" + parms;
        top.window.location.href = s;
    }
    function changeTrackLayer(p, updateBounds ) {        
        userOptions.myUserID = p;
        if(userOptions.myUserID!==null){
            trackLayerUpdate(p, true,document.getElementById("invalidCheckbox").checked);
        }
    }
    
    function checkPass(){        
        var password = document.getElementById('createPassword');
        var confirmPassword = document.getElementById('createConfirmPassword');        
        var message = document.getElementById('confirmMessage');
        var matchColor = "#66cc66";
        var noMatchColor = "#ff6666";
        if(password.value == confirmPassword.value){
            confirmPassword.style.backgroundColor = matchColor;
            message.style.color = matchColor;
            message.innerHTML = "Passwords Match"
        }else{
            confirmPassword.style.backgroundColor = noMatchColor;
            message.style.color = noMatchColor;
            message.innerHTML = "Please match the passwords"
        }
    }  
    
    function setUserSessions(text) {
        eval(text);
        //console.log(text);
        var cols = $rs.colnames;
        var type = $rs.coltypes;
        var data = $rs.rows || $rs[Object.keys($rs)[0]];
        str = "<form>";
        mobile_id = "";
        for ( i in data) {
            d = data [i];
            if (mobile_id != d[0]) {
                mobile_id = d[0]
                if(typeof(d[2]) === 'undefined'){
                   d[2] = "" 
                }
                if(typeof(d[3]) === 'undefined'){
                   d[3] = "" 
                }
                if(typeof(d[4]) === 'undefined'){
                   d[4] = "" 
                }
                str = str + "<hr>" +"Name: "+ d[2].replace(null,"") + " " + d[3].replace(null,"")+" Username: " +d[4].replace(null,"")+ " </hr><br>"
                
            }
            if ( d[1].indexOf("-") < 0) {
                p = "'mobile_id="+ d[0] + "&session_num=" + d[1] + "'"; // containst mobile_id and session num
            } else {
                p = "'mobile_id="+ d[0] + "&measured_at=" + d[1] + "'"; // containst mobile_id and session num
            }
            s = "changeTrackLayer(" + p + ")";
            
            a = "<label><input type=\"checkbox\" onchange=\"if(this.checked) {this.value='true'; setTrackLayerVisibility(true); stationLayerVoronoi.prototype.LayerUpdateNearestWeather('"+d[1]+"'); " + s + ";} else {this.value='false'; trackRemoveFeatureByMobIDAndMeasuredAt(\'"+d[0]+"\',\'"+ d[1]+"\');}\" name=\"Session\" value=\"false\">" + d[0] + "," + d[1] + "<br/></label>\n";
            //a = "<a href=# onclick=\"setTrackLayerVisibility(true);" + s + ";\" >" + d[0] + "," + d[1] + "</a><br/>\n"
            str = str  + a;
            if ( i == 0) {
                CURRENT_PARMS = p;
            }
        }
        str = str + "</form>"
        //$("#tabs-3").append(str);
        $("#sessiontracks").html("");;
        $("#sessiontracks").html(str);
    }
    function runQuery1(divName) {
        loggedInUserName = localStorage.getItem('name');
        //console.log("inside runquery1 and is name from localstorage is "+name); 
        if (typeof loggedInUserName !== 'undefined' && loggedInUserName !== null) {
            if (loggedInUserName == 'admin') {
                url = config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?qn=9a"
                url = config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?qn=15"
                submitForm({URL: url, fdata: {}, CB: setUserSessions})
            }
            else {
               // console.log("not an admin user.. not loaded");
                loggedInUserMobile_Id = localStorage.getItem('mobile_id');                
                url = config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?qn=26&username="+loggedInUserName;
                submitForm({URL: url, fdata: {}, CB: setUserSessions})
            }
        }
        else {
            //Not logged in, show synthetic route data            
            url = config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?qn=26&username=Synthetic";
            submitForm({URL: url, fdata: {}, CB: setUserSessions})
            showloginForm();
        }
    }
    
    function checkPassword(){
        loggedInUserName = localStorage.getItem('name');
        var currentPass = $('#currentPassword').val();
        
        $.ajax({
            type: "GET",
            url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=32",
            contentType: "application/json; charset=utf-8",
            dataType: "text",
            // send username and password as parameters to the python script
            data: "cname=" + loggedInUserName + "&passwd=" + currentPass ,
            // script call was *not* successful
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                console.log( XMLHttpRequest.responseText);   
            },
            success: function(data){
                eval(data);
                //console.log(text);
                var cols = $rs.colnames;
                var type = $rs.coltypes;
                var data = $rs.rows || $rs[Object.keys($rs)[0]];
                d = data[0];
                if(d[0]>0){
                    submitPassword();                    
                }                
                else{
                    $('#changePasswordMessage').text("The current password was incorrect.");
                }
            }// success
        });
    }
    
    function submitPassword(){
        loggedInUserName = localStorage.getItem('name');
        var currentPass = $('#currentPassword').val();
        var newPass = $('#newPassword').val();
        var newPass1 = $('#newPassword1').val();
        if(newPass == newPass1){
            $.ajax({
                type: "GET",
                url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=33",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                // send username and password as parameters to the python script
                data: "username=" + loggedInUserName + "&password=" + newPass,
                // script call was *not* successful
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                    console.log( XMLHttpRequest.responseText);   
                },
                success: function(data){
                    alert("New Password Set");
                    showProfile();
                }// success
            });
        }
        else{
            $('#changePasswordMessage').text("Your new passwords did not match each other");
        }
        
    }
    
    function createAccount(){
        var username = $('#createUsername').val();
        var password = $('#createPassword').val();
        var confirmPassword = $('#createConfirmPassword').val();
        var fname = $('#createFname').val();
        var lname = $('#createLname').val();
        var address = $('#createAddress').val();
        var cellphone = $('#createCellphone').val();
        var mobileid = $('#createMobileid').val();
        var homephone = $('#createHomephone').val();
        var home_location = $('#createHome_location').val();
        
        if(username && password && confirmPassword && password == confirmPassword ){
            $.ajax({
                type: "GET",
                url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=27",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                // send username and password as parameters to the python script
                data: "username=" + username + "&password=" + password + "&fname=" + fname+"&lname=" +lname+"&address="+address+"&cellphone="+cellphone+"&mobileid="+mobileid+"&homephone="+homephone+"&home_location="+home_location+"&viewable_mobileid="+mobileid,
                // script call was *not* successful
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                    console.log( XMLHttpRequest.responseText);   
                },
                success: function(data){
                    alert("New Account Created");
                    showloginForm();
                }// success
            });
        }
        else{
            
            $('#createAccountMessage').text("Invalid username, or passwords do not match");
        }
    } 
    
    function checkUsername(){
        var username = $('#createUsername').val();                     
        $.ajax({
            type: "GET",
            url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=31",
            contentType: "application/json; charset=utf-8",
            dataType: "text",
            // send username and password as parameters to the python script
            data: "cname=" + username ,
            // script call was *not* successful
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                console.log( XMLHttpRequest.responseText);   
            },
            success: function(data){
                eval(data);
                //console.log(text);
                var cols = $rs.colnames;
                var type = $rs.coltypes;
                var data = $rs.rows || $rs[Object.keys($rs)[0]];
                d = data[0];
                if(d[0]>0){
                    $('#createAccountMessage').text("There is already an account under that username.");
                }                
                else{
                    createAccount();
                }
            }// success
        });
    } 
    function runQuery2(){ // loginForm is submitted
        var username = $('#username').val(); // get username
        var password = $('#password').val(); // get password
        if (username && password) { // values are not empty
            $.ajax({
                type: "GET",
                url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=14",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                // send username and password as parameters to the python script
                data: "cname=" + username + "&passwd=" + password,
                // script call was *not* successful
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                    console.log( XMLHttpRequest.responseText);
                    $('div#loginResult').text(""
                    + ", textStatus: " + textStatus
                    + ", errorThrown: " + errorThrown);
                    $('div#loginResult').addClass("error");
                }, // error
                // script call was successful
                success: function(data){
                    if (data.error) { // script returned error
                        $('div#loginResult').text("data.error: " + data.error);
                        $('div#loginResult').addClass("error");
                    } // if
                    else { // data recieved
                        eval(data);
                        var data2 = $rs.rows || $rs[Object.keys($rs)[0]];
                        if(data2.length > 0) {
                            editprofile(data2);
                        }
                        else{
                            $('div#loginResult').text("Login Failed: " );
                            $('div#loginResult').addClass("error");
                        }
                    }
                } // success
            }); // ajax
        } // if
        else {
            $('div#loginResult').text("Please enter username and password");
            $('div#loginResult').addClass("error");
        } // else
        $('div#loginResult').fadeIn();
        return false;
    }
    function getProfileFromDB(){ // loginForm is submitted
        username = localStorage.getItem('name');
        console.log("username got from locastorgae is "+username);
        $.ajax({
            type: "GET",
            url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=17",
            contentType: "application/json; charset=utf-8",
            dataType: "text",
            // send username and password as parameters to the python script
            data: "cname=" +username,
            // script call was *not* successful
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            }, // error
            // script call was successful
            success: function(data){
                if (data.error) { // script returned error
                } // if
                else { // data recieved
                    eval(data);
                    var data2 = $rs.rows || $rs[Object.keys($rs)[0]];
                    if(data2.length > 0) {
                        editprofile(data2);
                        runQuery1();
                    }
                    else{
                        alert("Fetching the user information failed..please login again");
                        showloginForm();
                        return false;
                    }
                }
            } // success
        }); // ajax
    }
    function logout() { // profileForm is submitted
        localStorage.removeItem('name');
        localStorage.removeItem('mobile_id');
       showloginForm();
        //$('[href="#tabs-3”]’).closest('li').hide();
        $('[href="#tabs-3"]').closest('li').show();
        runQuery1();
    }
    
    function editprofile(data2) {
                    if(data2.length > 0) {
                        for ( i in data2)
                            d = data2 [i];
                        localStorage.setItem('name', d[3]);
                        localStorage.setItem('mobile_id',d[6]);
                        userSysId = d[0];
                        $("#fname").val(d[1].replace(null,""));
                        $("#lname").val(d[2].replace(null,""));
                        $("#address").val(d[4].replace(null,""));
                        $("#cellphone").val(d[5].replace(null,""));
                        $("#mobileid").val(d[6].replace(null,""));
                        $("#homephone").val(d[7].replace(null,""));
                        $("#home_location").val(d[9].replace(null,""));
                        showProfile();
                        showMenuAlways();
                        $('[href="#tabs-3"]').closest('li').show();
                        runQuery1();
                        //  ["userid","fname","lname","cname","address","cellphone","mobileid","homephone","passwd","home_location"]
                    }
                }
    function changepassword(){
        //console.log("called change password function");
        loggedInUserName = localStorage.getItem('name');
         if (loggedInUserName == 'admin') {
                alert("You can not change the admin account password.");
         }
         else{
                $('div#loginContent').hide();
                $('div#profile').hide();
                $('div#createAccount').hide();
                $('div#useroptions').show();
                $('div#changePassword').show();
         }
    }
    function showMenu(){
        $('div#changePassword').hide();
        $('div#loginContent').hide();
        $('div#profile').hide();
        $('div#useroptions').show();
        $('div#createAccount').hide();
    }
    function showMenuAlways(){
        $('div#useroptions').show();
    }
    function showloginForm(){
        $('div#loginContent').show();
        $('div#useroptions').hide();
        $('div#profile').hide();
        $('div#changePassword').hide();
        $('div#createAccount').hide();
    }
    
    function showCreateProfile(){
        $('div#loginContent').hide();
        $('div#useroptions').hide();
        $('div#profile').hide();
        $('div#changePassword').hide();
        $('div#createAccount').show();
    }
    function showProfile(){
        $('div#loginContent').hide();
        $('div#useroptions').hide();
        $('div#profile').show();
        $('div#changePassword').hide();
        $('div#createAccount').hide();
    }
    function runQuery3(){ // profileForm is submitted
        var fname = $('#fname').val(); // get username
        var lname = $('#lname').val();
        var address = $('#address').val();
        var cellphone = $('#cellphone').val();
        var mobileid = $('#mobileid').val();
        var homephone = $('#homephone').val();
        var home_location = $('#home_location').val();
     ///   var sqlQuerytoUpdate = "update public.user set lname='"+lname+"' , fname='" + fname+ "' , address='" + address+ "', cellphone='" + cellphone+
     // "', mobileid='" + mobileid+ "', homephone='" + homephone+ "', home_location='" + home_location+ "'where userid ="+userSysId;
        if (lname && fname) { // values are not empty
            $.ajax({
                type: "GET",
                url: config.PROXY + GEOPROXY + "/aura/webroot/db.jsp?api_key=test&qn=16",
                contentType: "application/text; charset=utf-8",
                dataType: "text",
                data: "fname=" + fname + "&lname=" + lname+ "&address=" + address+ "&cellphone=" + cellphone+ "&mobileid=" +
                mobileid+ "&homephone=" + homephone+"&home_location=" + home_location+"&userSysId=" + userSysId,
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    //  $('div#loginResult').text("responseText: " + XMLHttpRequest.responseText
                    console.log( XMLHttpRequest.responseText);
                    $('div#profileResult').text(""
                    + ", textStatus: " + textStatus
                    + ", errorThrown: " + errorThrown);
                    $('div#profileResult').addClass("error");
                }, // error
                // script call was successful
                complete : function(){
                    alert(this.url)
                },
                success: function(data){
                    if (data.error) { // script returned error
                        $('div#profileResult').text("data.error: " + data.error);
                        $('div#profileResult').addClass("error");
                    } // if
                    else { // data recieved
                                $.ajax({
                                    url: GEOPROXY + "/aura/webroot/db.jsp?cmd=reload"
                                }).done(function() {
                                    $('div#profileResult').text("Profile saved");
                                    $('div#profileResult').addClass("success");
                                });
                    }
                } // success
            }); // ajax
        } // if
        else {
            $('div#profileResult').text("Please enter the required fields");
            $('div#profileResult').addClass("error");
        } // else
        $('div#profileResult').fadeIn();
        return false;
    }
/*
    $(document).ready(function() {
        //console.log("before loading the userinfo.html");
        $('#tabs-1').load('Userinfo.html');
    });*/
</script>

</body>
</html>
